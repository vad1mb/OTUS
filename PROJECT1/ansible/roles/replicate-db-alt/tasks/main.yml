- name: 'Enable service MariaDB'
  service:
    name: mariadb
    state: started
    enabled: yes

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ server-id 
- name: "Config: Set server-id"
  lineinfile:
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: "^ *#* *server-id"
    line: "server-id = {{ db_server_id }}"
    # backup: yes
  notify: Restart MariaDB Service

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ Master
- name: Create replication user {{ dbuser_replicator }} on Master
  community.mysql.mysql_user:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    name: "{{ dbuser_replicator }}"
    password: "{{ dbuser_replicator_pass }}"
    host: "{{ item }}"
    priv: '*.*:REPLICATION SLAVE'
    state: present
  loop: "{{ replication_host }}"
  when: db_server_id == 1
  notify: flush priveleges

# –ö–æ–ø–∏—Ä—É–µ–º config —Ñ–∞–π–ª –¥–ª—è Master c –≤–∫–ª—é—á–µ–Ω—ã–º binlog
- name: Copy config Master Server with Enable binlog
  template:
    src: 50-server-master.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
  when: db_server_id == 1
  notify: Restart MariaDB Service         # üî¥ –°—Ç—Ä–∞–Ω–Ω–æ, –Ω–æ —Ö–µ–Ω–¥–ª–µ—Ä –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- name: Restart MariaDB Service
  service:
    name: mariadb
    state: restarted
    enabled: yes  

#-----------------------------------------------

# –ß–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—É—Å Master-–∞. Master –≤–µ—Ä–Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –¥—Ä—É–≥–∏–µ - –Ω–∏—á–µ–≥–æ
- name: Get MariaDB master state
  community.mysql.mysql_info:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    filter: master_status
  register: db_master_status

- debug:
    msg: "{{ db_server_id }} - {{ db_master_status.master_status }}"
  when: db_debug|default(False) == True

# # –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Ç–µ—Ä, –Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –≤—ã–¥–∞–µ—Ç —Ç–æ –¥–µ–ª–∞–µ–º reset –¥–ª—è binlog    ‚ùì –≠—Ç–æ—Ç —à–∞–≥ –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å—Å—è?
# - name: "(Master) Reset binlog"
#   command: '/usr/bin/mysql -u root -e "RESET MASTER"'
#   when: db_server_id == 1 and db_master_status.master_status == {}

# –ß–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—É—Å Slave-–∞. –ï—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞, —Ç–æ –≤–µ—Ä–Ω–µ—Ç Slave_IO_Running: Yes, –∏–Ω–∞—á–µ - No
- name: "(Slave) Get status"
  community.mysql.mysql_replication:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    mode: getslave
  register: db_slave_status


- debug:
    var: db_slave_status.Slave_IO_Running
  when: db_debug|default(False) == True

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è Slave –µ—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –µ—â–µ –Ω–µ—Ç.
- name: "(Slave) Setup replication"
  command: '/usr/bin/mysql -u root -e "CHANGE MASTER TO master_host=\"{{ master_host }}\", master_user=\"{{ dbuser_replicator }}\", master_password=\"{{ dbuser_replicator_pass }}\", master_use_gtid=current_pos"'
  when: db_server_id != 1 and db_slave_status.Slave_IO_Running|default("No") == "No"
  notify: 'Restart MariaDB Service'

# - debug:
#     msg: "master_host= {{ master_host }}"
#   when: db_debug|default(False) == True

# –ó–∞–ø—É—Å–∫ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è Slave –µ—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –µ—â–µ –Ω–µ—Ç.
- name: "(Slave) Start slave"
  community.mysql.mysql_replication:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    mode: startslave
  when: db_server_id != 1 and db_slave_status.Slave_IO_Running|default("No") == "No"
